<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Sentence Builder</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <style>
        /* Your existing CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex; /* Use flexbox for overall centering if needed */
            justify-content: center; /* Center horizontally */
            align-items: flex-start; /* Align to the top of the viewport */
        }

        /* New container for the two-panel layout */
        .main-container {
            max-width: 1200px; /* Increased max-width for two panels */
            width: 100%;
            margin: 0 auto; /* Center the container */
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; /* Stacks the H1 above the panels */
            gap: 20px; /* Space between title and panels */
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px; /* Reduced margin, as main-container has gap now */
            font-size: 2.5em;
            font-weight: 300;
        }

        /* Flex container for the two panels */
        .main-layout {
            display: flex;
            gap: 30px; /* Space between the left and right panels */
            flex-wrap: wrap; /* Allows panels to stack on smaller screens */
            width: 100%;
        }

        .left-panel, .right-panel {
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            /* flex: 1; default for even distribution */
        }

        .left-panel {
            flex: 2; /* Left panel takes more space (e.g., 2/3 of available space) */
            background: #e9f0f9; /* Light background for building blocks */
            min-width: 300px; /* Ensure left panel doesn't get too small */
            max-height: 85vh; /* Limit height to enable scrolling within the panel */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 15px; /* Adjust padding for scrollbar */
        }

        /* Custom scrollbar for left panel */
        .left-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .left-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .left-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .right-panel {
            flex: 1; /* Right panel takes less space (e.g., 1/3 of available space) */
            background: #f7fafc; /* Lighter background for sentence */
            border: 2px dashed #cbd5e0; /* Match sentence builder border visually */
            min-width: 280px; /* Ensure right panel doesn't get too small */
            display: flex;
            flex-direction: column; /* Stack sentence, button, info vertically */
            justify-content: flex-start; /* Align content to the top */
            position: sticky; /* Keep it visible when scrolling left panel */
            top: 20px; /* Distance from top of viewport */
            align-self: flex-start; /* Align to the start of the cross axis (top) */
            min-height: 250px; /* Ensure some minimum height */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 900px) {
            .main-layout {
                flex-direction: column; /* Stack panels vertically */
            }
            .left-panel, .right-panel {
                min-width: unset; /* Remove min-width when stacked */
                max-height: unset; /* Remove max-height, allow content to dictate height */
                overflow-y: visible; /* No internal scrolling when stacked */
                position: static; /* Remove sticky positioning */
            }
        }

        /* Styles for collapsible sections */
        .collapsible-section {
            margin-bottom: 15px; /* Space between collapsible blocks */
            border-radius: 10px;
            overflow: hidden; /* Important for max-height transition */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .collapsible-header {
            background: #e2e8f0;
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #cbd5e0;
            transition: background-color 0.2s ease;
        }

        .collapsible-header:hover {
            background-color: #d8dee7;
        }

        .collapsible-header .icon {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }

        .collapsible-header.active .icon {
            transform: rotate(90deg); /* Rotate for expand indication */
        }

        .collapsible-content {
            background: white;
            max-height: 0; /* Hidden by default */
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* Smooth transition */
            padding: 0 20px; /* No padding when collapsed */
        }

        .collapsible-content.active {
            max-height: 500px; /* Or a sufficiently large value for content to show */
            padding: 20px; /* Add padding when expanded */
            /* You might need to adjust max-height if your word grids become very long */
            /* A better approach for very dynamic content might be JS-calculated height */
        }

        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Adjusted minmax for more columns */
            gap: 8px; /* Slightly reduced gap */
            margin-bottom: 0; /* Remove bottom margin from grid, controlled by content padding */
        }

        .word-button {
            padding: 10px 14px; /* Slightly smaller padding for denser grid */
            border: none;
            border-radius: 10px; /* Slightly smaller radius */
            cursor: pointer;
            font-size: 13px; /* Slightly smaller font */
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* Slightly smaller shadow */
        }

        .word-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }

        /* NEW COLOR CODES for word buttons and sentence parts */
        .verb-button, .verb-part {
            background: linear-gradient(135deg, #F04A4A 0%, #C82828 100%); /* Red */
            color: white;
        }
        .noun-button, .noun-part {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); /* Green */
            color: white;
        }
        .article-button, .article-part {
            background: linear-gradient(135deg, #FFEB3B 0%, #FBC02D 100%); /* Yellow */
            color: #333; /* Darker text for yellow */
        }
        .pronoun-button, .pronoun-part {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); /* Pink */
            color: white;
        }
        .adjective-button, .adjective-part {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); /* Blue */
            color: white;
        }
        .adverb-button, .adverb-part {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); /* Purple */
            color: white;
        }
        .preposition-button, .preposition-part {
            background: linear-gradient(135deg, #795548 0%, #5D4037 100%); /* Brown */
            color: white;
        }
        .conjunction-button, .conjunction-part {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); /* Orange */
            color: white;
        }

        /* General styles for Mood and Tense (gray) */
        .mood-tense-section {
            background: #eceff1; /* Lighter gray for content */
            border: 1px solid #cfd8dc;
            box-shadow: none; /* No extra shadow */
        }
        .mood-tense-section .collapsible-header {
            background: #cfd8dc; /* Gray header */
            color: #455a64;
            border-bottom: none;
        }
        .mood-tense-section .collapsible-header:hover {
            background-color: #b0bec5;
        }
        .mood-tense-section .collapsible-content {
            background: #eceff1;
            color: #546e7a;
            font-style: italic;
            text-align: center;
        }


        .sentence-builder {
            border: none;
            background: none;
            padding: 10px;
            text-align: center;
            margin: 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            flex-grow: 1; 
        }

        .sentence-part {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 8px rgba[0m rgba(0,0,0,0.1);
            cursor: grab;
            display: flex;
            align-items: center;
            position: relative;
        }

        .remove-sentence-part {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            line-height: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s;
        }

        .remove-sentence-part:hover {
            background-color: #c53030;
        }

        .clear-button {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .placeholder {
            color: #a0aec0;
            font-style: italic;
        }

        .conjugation-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            color: #4a5568;
        }

        /* New single add word section */
        .add-word-section {
            background: #f8f9fa; /* Light gray/off-white background */
            border: 2px dashed #b0bec5; /* Subtle dashed border */
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px; /* Space from other sections */
        }
        .add-word-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #455a64; /* Darker gray text */
        }
        .add-word-form {
            display: grid;
            grid-template-columns: 1fr; /* Single column for input and button */
            gap: 15px;
            align-items: end;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #607d8b; /* Neutral focus color */
        }
        .add-button-general {
            background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); /* Gray/blue-gray button */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            height: fit-content;
            transition: transform 0.3s ease;
            width: 100%; /* Full width */
        }
        .add-button-general:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }
        .custom-word-list { /* For displaying added words */
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .custom-word-list > div {
            font-weight: 600;
            color: #2d3748;
            width: 100%; /* Ensures title takes full width */
        }
        .custom-tag { /* General style for custom word tags */
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            position: relative;
            color: white;
            background: #b0bec5; /* Default custom tag color */
        }
        .custom-tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>üåü Constructor de Oraciones en Espa√±ol</h1>
        
        <div class="main-layout">
            <div class="left-panel">
                <div class="collapsible-section">
                    <div class="collapsible-header pronoun-button">
                        <span>üôã Pronombres (Pronouns)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="pronounGrid">
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'yo')">yo</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 't√∫')">t√∫</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', '√©l')">√©l</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'ella')">ella</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'usted')">usted</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'nosotros')">nosotros</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'vosotros')">vosotros</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'ustedes')">ustedes</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'ellos')">ellos</button>
                            <button class="word-button pronoun-button" onclick="addWordToSentence('pronoun', 'ellas')">ellas</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header verb-button">
                        <span>‚ö° Verbos (Verbs)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="verbGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header noun-button">
                        <span>üéØ Sustantivos (Nouns)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="nounGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header article-button">
                        <span>üìù Art√≠culos (Articles)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="articleGrid">
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'el')">el</button>
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'la')">la</button>
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'los')">los</button>
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'las')">las</button>
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'un')">un</button>
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'una')">una</button>
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'unos')">unos</button>
                            <button class="word-button article-button" onclick="addWordToSentence('article', 'unas')">unas</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header adjective-button">
                        <span>‚ú® Adjetivos (Adjectives)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="adjectiveGrid">
                             <button class="word-button adjective-button" onclick="addWordToSentence('adjective', 'grande')">grande</button>
                            <button class="word-button adjective-button" onclick="addWordToSentence('adjective', 'peque√±o')">peque√±o</button>
                            <button class="word-button adjective-button" onclick="addWordToSentence('adjective', 'feliz')">feliz</button>
                            <button class="word-button adjective-button" onclick="addWordToSentence('adjective', 'triste')">triste</button>
                            <button class="word-button adjective-button" onclick="addWordToSentence('adjective', 'bonito')">bonito</button>
                            <button class="word-button adjective-button" onclick="addWordToSentence('adjective', 'nuevo')">nuevo</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header adverb-button">
                        <span>üí® Adverbios (Adverbs)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="adverbGrid">
                            <button class="word-button adverb-button" onclick="addWordToSentence('adverb', 'r√°pidamente')">r√°pidamente</button>
                            <button class="word-button adverb-button" onclick="addWordToSentence('adverb', 'lentamente')">lentamente</button>
                            <button class="word-button adverb-button" onclick="addWordToSentence('adverb', 'muy')">muy</button>
                            <button class="word-button adverb-button" onclick="addWordToSentence('adverb', 'bien')">bien</button>
                            <button class="word-button adverb-button" onclick="addWordToSentence('adverb', 'mal')">mal</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header preposition-button">
                        <span>üìç Preposiciones (Prepositions)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="prepositionGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header conjunction-button">
                        <span>‚ûï Conjunciones (Conjunctions)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="conjunctionGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section mood-tense-section">
                    <div class="collapsible-header">
                        <span>üí° Modo (Mood)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <p>
                            (Funcionalidad futura: elige el modo del verbo)
                        </p>
                    </div>
                </div>

                <div class="collapsible-section mood-tense-section">
                    <div class="collapsible-header">
                        <span>‚è∞ Tiempo (Tense)</span>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="collapsible-content">
                        <p>
                            (Funcionalidad futura: elige el tiempo verbal)
                        </p>
                    </div>
                </div>

                <div class="add-word-section">
                    <div class="add-word-title">‚úçÔ∏è A√±adir Palabra Personalizada</div>
                    <div class="add-word-form">
                        <div class="form-group">
                            <label class="form-label">Introduce una palabra</label>
                            <input type="text" class="form-input" id="newCustomWord" placeholder="ej: sustantivo, verbo, adjetivo...">
                        </div>
                        <button class="add-button-general" onclick="addNewCustomWord()">‚ûï A√±adir</button>
                    </div>
                    <div class="custom-word-list" id="customWordList">
                        <div>Palabras a√±adidas:</div>
                        </div>
                     <p style="font-size: 0.8em; color: #666; text-align: center; margin-top: 15px;">
                        * La clasificaci√≥n autom√°tica es b√°sica. Si la palabra no se clasifica correctamente, se te pedir√° que lo confirmes.
                        La agrupaci√≥n de sustantivos (ej. "animales") es una caracter√≠stica futura.
                    </p>
                </div>

            </div> <div class="right-panel">
                <div class="sentence-builder" id="sentenceBuilder">
                    <span class="placeholder">Arrastra y suelta palabras aqu√≠ para construir tu oraci√≥n...</span>
                </div>

                <button class="clear-button" onclick="clearSentence()">üîÑ Limpiar Oraci√≥n</button>

                <div class="conjugation-info" id="conjugationInfo" style="display: none;">
                    <strong>üí° Informaci√≥n de conjugaci√≥n:</strong>
                    <div id="conjugationDetails"></div>
                </div>
            </div> </div> </div> <script>
        let sentenceElements = []; 

        let allVerbsData = {}; 
        
        // Consolidated custom word storage
        let customWords = {
            verbs: [],
            nouns: [],
            articles: [],
            pronouns: [],
            adjectives: [],
            adverbs: [],
            prepositions: [],
            conjunctions: []
        };
        
        // Default lists for new categories (can be expanded)
        const defaultPronouns = ['yo', 't√∫', '√©l', 'ella', 'usted', 'nosotros', 'vosotros', 'ustedes', 'ellos', 'ellas'];
        const defaultNouns = ['el libro', 'la comida', 'el espa√±ol', 'la m√∫sica', 'el agua', 'la carta', 'el trabajo', 'la pel√≠cula']; 
        const defaultArticles = ['el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas'];
        const defaultAdjectives = ['grande', 'peque√±o', 'feliz', 'triste', 'bonito', 'nuevo', 'viejo', 'r√°pido', 'lento'];
        const defaultAdverbs = ['r√°pidamente', 'lentamente', 'muy', 'bien', 'mal', 'siempre', 'nunca', 'aqu√≠', 'all√≠'];
        const defaultPrepositions = ['a', 'ante', 'bajo', 'con', 'de', 'desde', 'en', 'entre', 'hacia', 'hasta', 'para', 'por', 'seg√∫n', 'sin', 'sobre', 'tras']; 
        const defaultConjunctions = ['y', 'o', 'pero', 'aunque', 'porque', 'si', 'cuando', 'mientras', 'entonces']; 

        const VERBS_JSON_URL = 'https://raw.githubusercontent.com/irwingbrian/languagelearningtool/refs/heads/main/verbs.json';

        // --- localStorage Helper Functions ---
        function saveCustomData() {
            try {
                localStorage.setItem('customWords', JSON.stringify(customWords));
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                alert("Error al guardar tus palabras personalizadas. El almacenamiento local podr√≠a estar lleno o deshabilitado.");
            }
        }

        function loadCustomData() {
            try {
                const storedWords = localStorage.getItem('customWords');
                if (storedWords) {
                    const parsedWords = JSON.parse(storedWords);
                    // Merge with default structure to ensure all categories exist
                    Object.keys(customWords).forEach(key => {
                        if (parsedWords[key]) {
                            customWords[key] = parsedWords[key];
                        }
                    });
                }
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                alert("Error al cargar tus palabras personalizadas. Podr√≠an estar corruptas.");
                localStorage.removeItem('customWords'); // Clear corrupted data
                // Reset to empty arrays if corrupted
                Object.keys(customWords).forEach(key => customWords[key] = []);
            }
        }

        // Function to fetch verbs data
        async function fetchVerbsData() {
            try {
                const response = await fetch(VERBS_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allVerbsData = data; 
                updateGrids(); // Update all grids after fetching data
            } catch (error) {
                console.error("Could not fetch verbs data:", error);
                alert("Error al cargar los verbos predeterminados. Verifica la URL del JSON o tu conexi√≥n a internet.");
            }
        }

        // Conjugation engine for regular verbs
        function conjugateRegularVerb(verb, type, subject) {
            const stem = verb.slice(0, -2); 
            
            const endings = {
                'regular-ar': {
                    'yo': 'o', 't√∫': 'as', '√©l': 'a', 'ella': 'a', 'usted': 'a', 
                    'nosotros': 'amos', 'vosotros': '√°is', 'ustedes': 'an', 'ellos': 'an', 'ellas': 'an' 
                },
                'regular-er': {
                    'yo': 'o', 't√∫': 'es', '√©l': 'e', 'ella': 'e', 'usted': 'e',
                    'nosotros': 'emos', 'vosotros': '√©is', 'ustedes': 'en', 'ellos': 'en', 'ellas': 'en' 
                },
                'regular-ir': {
                    'yo': 'o', 't√∫': 'es', '√©l': 'e', 'ella': 'e', 'usted': 'e',
                    'nosotros': 'imos', 'vosotros': '√≠s', 'ustedes': 'en', 'ellos': 'en', 'ellas': 'en' 
                }
            };
            return stem + endings[type][subject];
        }

        function generateConjugation(verb, type) {
            const conjugation = {};
            const subjects = ['yo', 't√∫', '√©l', 'ella', 'usted', 'nosotros', 'vosotros', 'ustedes', 'ellos', 'ellas']; 
            
            subjects.forEach(subject => {
                conjugation[subject] = conjugateRegularVerb(verb, type, subject);
            });

            return conjugation;
        }

        // --- Add Word to Sentence Function (replaces select functions) ---
        function addWordToSentence(type, value) {
            sentenceElements.push({ type, value });
            updateSentence();
        }

        function removeWordFromSentence(index) {
            sentenceElements.splice(index, 1);
            updateSentence();
        }

        // --- Grid Update Functions (Combined) ---
        function updateGrids() {
            updateVerbGrid(); 
            updateNounGrid(); 
            updatePronounGrid();
            updateArticleGrid();
            updateAdjectiveGrid();
            updateAdverbGrid();
            updatePrepositionGrid(); 
            updateConjunctionGrid();
            updateCustomWordsDisplay(); // Update the consolidated custom word list
        }

        function updateVerbGrid() {
            const verbGrid = document.getElementById('verbGrid');
            verbGrid.innerHTML = ''; 

            const allVerbsToDisplay = { ...allVerbsData }; 
            customWords.verbs.forEach(verbData => {
                if (!verbData.conjugations) {
                    if (verbData.type !== 'irregular') {
                         verbData.conjugations = generateConjugation(verbData.verb, verbData.type);
                    } else {
                        verbData.conjugations = {
                            'yo': `${verbData.verb}*`, 't√∫': `${verbData.verb}*`, '√©l': `${verbData.verb}*`, 'ella': `${verbData.verb}*`, 'usted': `${verbData.verb}*`,
                            'nosotros': `${verbData.verb}*`, 'vosotros': `${verbData.verb}*`, 'ustedes': `${verbData.verb}*`, 'ellos': `${verbData.verb}*`, 'ellas': `${verbData.verb}*` 
                        };
                    }
                }
                allVerbsToDisplay[verbData.verb] = verbData; 
            });

            const verbInfinitives = Object.keys(allVerbsToDisplay).sort();

            verbInfinitives.forEach(verb => {
                const button = document.createElement('button');
                button.className = 'word-button verb-button'; // New class for verbs
                button.textContent = verb;
                button.onclick = () => addWordToSentence('verb', verb); 
                
                const verbInfo = allVerbsToDisplay[verb];

                // Override color for custom or irregular verbs if desired
                if (customWords.verbs.some(v => v.verb === verb)) {
                    // Custom verbs can have a distinct shade of red if desired, or just use the general verb-button
                    button.style.background = 'linear-gradient(135deg, #FF6F6F 0%, #D03939 100%)'; 
                } else if (verbInfo.type === 'irregular') {
                    button.style.background = 'linear-gradient(135deg, #C82828 0%, #A01B1B 100%)'; // Darker red for irregular
                }
                
                verbGrid.appendChild(button);
            });
        }

        function updateNounGrid() { 
            const nounGrid = document.getElementById('nounGrid'); 
            nounGrid.innerHTML = ''; 
            
            const allNounsToDisplay = [...defaultNouns, ...customWords.nouns].sort(); 

            allNounsToDisplay.forEach(noun => {
                const button = document.createElement('button');
                button.className = 'word-button noun-button'; // New class for nouns
                button.textContent = noun;
                button.onclick = () => addWordToSentence('noun', noun); 
                if (customWords.nouns.includes(noun)) {
                    button.style.background = 'linear-gradient(135deg, #66BB6A 0%, #2E7D32 100%)'; // Custom noun shade
                }
                nounGrid.appendChild(button);
            });
        }

        function updatePronounGrid() {
            const pronounGrid = document.getElementById('pronounGrid');
            pronounGrid.innerHTML = ''; // Clear existing
            const allPronounsToDisplay = [...defaultPronouns, ...customWords.pronouns].sort();
            allPronounsToDisplay.forEach(pronoun => {
                const button = document.createElement('button');
                button.className = 'word-button pronoun-button';
                button.textContent = pronoun;
                button.onclick = () => addWordToSentence('pronoun', pronoun);
                if (customWords.pronouns.includes(pronoun)) {
                     button.style.background = 'linear-gradient(135deg, #FF4081 0%, #AD1457 100%)'; // Custom pronoun shade
                }
                pronounGrid.appendChild(button);
            });
        }

        function updateArticleGrid() {
            const articleGrid = document.getElementById('articleGrid');
            articleGrid.innerHTML = ''; 
            const allArticlesToDisplay = [...defaultArticles, ...customWords.articles].sort();
            allArticlesToDisplay.forEach(article => {
                const button = document.createElement('button');
                button.className = 'word-button article-button';
                button.textContent = article;
                button.onclick = () => addWordToSentence('article', article);
                if (customWords.articles.includes(article)) {
                    button.style.background = 'linear-gradient(135deg, #FFD54F 0%, #FFB300 100%)'; // Custom article shade
                }
                articleGrid.appendChild(button);
            });
        }

        function updateAdjectiveGrid() {
            const adjectiveGrid = document.getElementById('adjectiveGrid');
            adjectiveGrid.innerHTML = ''; 
            const allAdjectivesToDisplay = [...defaultAdjectives, ...customWords.adjectives].sort();
            allAdjectivesToDisplay.forEach(adjective => {
                const button = document.createElement('button');
                button.className = 'word-button adjective-button';
                button.textContent = adjective;
                button.onclick = () => addWordToSentence('adjective', adjective);
                if (customWords.adjectives.includes(adjective)) {
                     button.style.background = 'linear-gradient(135deg, #64B5F6 0%, #1565C0 100%)'; // Custom adjective shade
                }
                adjectiveGrid.appendChild(button);
            });
        }

        function updateAdverbGrid() {
            const adverbGrid = document.getElementById('adverbGrid');
            adverbGrid.innerHTML = ''; 
            const allAdverbsToDisplay = [...defaultAdverbs, ...customWords.adverbs].sort();
            allAdverbsToDisplay.forEach(adverb => {
                const button = document.createElement('button');
                button.className = 'word-button adverb-button';
                button.textContent = adverb;
                button.onclick = () => addWordToSentence('adverb', adverb);
                if (customWords.adverbs.includes(adverb)) {
                     button.style.background = 'linear-gradient(135deg, #BA68C8 0%, #6A1B9A 100%)'; // Custom adverb shade
                }
                adverbGrid.appendChild(button);
            });
        }

        function updatePrepositionGrid() { 
            const prepositionGrid = document.getElementById('prepositionGrid');
            prepositionGrid.innerHTML = ''; 
            
            const allPrepositionsToDisplay = [...defaultPrepositions, ...customWords.prepositions].sort();

            allPrepositionsToDisplay.forEach(preposition => {
                const button = document.createElement('button');
                button.className = 'word-button preposition-button'; // New class
                button.textContent = preposition;
                button.onclick = () => addWordToSentence('preposition', preposition); 
                if (customWords.prepositions.includes(preposition)) {
                    button.style.background = 'linear-gradient(135deg, #A1887F 0%, #4E342E 100%)'; // Custom preposition shade
                }
                prepositionGrid.appendChild(button);
            });
        }

        function updateConjunctionGrid() { 
            const conjunctionGrid = document.getElementById('conjunctionGrid');
            conjunctionGrid.innerHTML = ''; 
            
            const allConjunctionsToDisplay = [...defaultConjunctions, ...customWords.conjunctions].sort();

            allConjunctionsToDisplay.forEach(conjunction => {
                const button = document.createElement('button');
                button.className = 'word-button conjunction-button'; // New class
                button.textContent = conjunction;
                button.onclick = () => addWordToSentence('conjunction', conjunction); 
                if (customWords.conjunctions.includes(conjunction)) {
                    button.style.background = 'linear-gradient(135deg, #FFB74D 0%, #E65100 100%)'; // Custom conjunction shade
                }
                conjunctionGrid.appendChild(button);
            });
        }


        // --- Add/Remove Custom Word Functions (Consolidated) ---
        function addNewCustomWord() {
            const wordInput = document.getElementById('newCustomWord');
            const word = wordInput.value.trim().toLowerCase();
            
            if (!word) {
                alert('Por favor, introduce una palabra para a√±adir.');
                return;
            }

            // Basic Classification Logic
            let classifiedType = null;

            // 1. Check if it's a known preposition
            if (defaultPrepositions.includes(word) || customWords.prepositions.includes(word)) {
                classifiedType = 'preposition';
            } 
            // 2. Check if it's a known conjunction
            else if (defaultConjunctions.includes(word) || customWords.conjunctions.includes(word)) {
                classifiedType = 'conjunction';
            }
            // 3. Check if it's a known article
            else if (defaultArticles.includes(word) || customWords.articles.includes(word)) {
                classifiedType = 'article';
            }
            // 4. Check if it's a known pronoun
            else if (defaultPronouns.includes(word) || customWords.pronouns.includes(word)) {
                classifiedType = 'pronoun';
            }
            // 5. Check if it's a verb (based on ending or existing data)
            else if (word.endsWith('ar') || word.endsWith('er') || word.endsWith('ir')) {
                // If it ends in ar/er/ir, assume regular unless explicitly irregular in allVerbsData
                let verbType = `regular-${word.slice(-2)}`;
                if (allVerbsData[word] && allVerbsData[word].type === 'irregular') {
                    verbType = 'irregular';
                }
                classifiedType = 'verb';
                
                // Add verb with its type and conjugations
                if (customWords.verbs.some(v => v.verb === word) || allVerbsData[word]) {
                    alert('Este verbo ya existe en la lista.');
                    return;
                }
                let conjugations = {};
                if (verbType !== 'irregular') {
                    conjugations = generateConjugation(word, verbType);
                } else {
                    // Placeholder for irregular verbs
                    conjugations = {
                        'yo': `${word}*`, 't√∫': `${word}*`, '√©l': `${word}*`, 'ella': `${word}*`, 'usted': `${word}*`,
                        'nosotros': `${word}*`, 'vosotros': `${word}*`, 'ustedes': `${word}*`, 'ellos': `${word}*`, 'ellas': `${word}*` 
                    };
                }
                customWords.verbs.push({ verb: word, type: verbType, conjugations });
                saveCustomData();
                updateGrids();
                alert(`"${word}" clasificado como: Verbo (${verbType}) y a√±adido.`);
                wordInput.value = '';
                return; // Exit after adding verb
            }
            // 6. Check if it's a known noun (simple check for "el/la/los/las " prefix)
            else if (word.startsWith('el ') || word.startsWith('la ') || word.startsWith('los ') || word.startsWith('las ')) {
                classifiedType = 'noun';
            }
            // 7. Check if it's a known adjective
            else if (defaultAdjectives.includes(word) || customWords.adjectives.includes(word)) {
                classifiedType = 'adjective';
            }
            // 8. Check if it's a known adverb
            else if (defaultAdverbs.includes(word) || customWords.adverbs.includes(word)) {
                classifiedType = 'adverb';
            }
            
            // If classification is ambiguous or new, prompt user
            if (!classifiedType) {
                const choice = prompt(`No pude clasificar autom√°ticamente "${word}". ¬øQu√© tipo de palabra es? (verb, noun, article, pronoun, adjective, adverb, preposition, conjunction)`);
                if (choice) {
                    const normalizedChoice = choice.trim().toLowerCase();
                    const validTypes = Object.keys(customWords); // Get valid categories
                    if (validTypes.includes(normalizedChoice)) {
                        classifiedType = normalizedChoice;
                    } else {
                        alert(`Tipo de palabra inv√°lido: "${choice}". Por favor, usa uno de: ${validTypes.join(', ')}.`);
                        return;
                    }
                } else {
                    alert('Operaci√≥n cancelada. No se a√±adi√≥ la palabra.');
                    return;
                }
            }

            // Add to the specific customWords array if not a verb (verbs handled above)
            if (classifiedType !== 'verb') {
                if (customWords[classifiedType] && !customWords[classifiedType].includes(word)) {
                    customWords[classifiedType].push(word);
                    saveCustomData();
                    updateGrids();
                    alert(`"${word}" clasificado como: ${classifiedType} y a√±adido.`);
                } else {
                    alert(`"${word}" ya existe en la categor√≠a "${classifiedType}".`);
                }
            }
            
            wordInput.value = '';
        }

        // --- Update Consolidated Custom Word Display ---
        function updateCustomWordsDisplay() {
            const container = document.getElementById('customWordList');
            // Keep the "Palabras a√±adidas:" title
            while (container.children.length > 1) { 
                container.removeChild(container.lastChild);
            }
            
            // Iterate through all custom word categories
            Object.keys(customWords).forEach(type => {
                customWords[type].forEach((word, index) => {
                    const tag = document.createElement('span');
                    tag.className = `custom-tag ${type}-button`; // Apply color class
                    
                    let displayWord = word;
                    if (type === 'verbs' && typeof word === 'object') { // For verb objects
                        displayWord = `${word.verb} (${word.type})`;
                    }
                    
                    tag.innerHTML = `${displayWord} <span class="remove-tag" onclick="removeCustomWord('${type}', ${index})">√ó</span>`;
                    container.appendChild(tag);
                });
            });
        }

        function removeCustomWord(type, index) {
            let removedWord;
            if (type === 'verbs') { // Verbs are objects
                removedWord = customWords.verbs[index].verb;
                customWords.verbs.splice(index, 1);
            } else {
                removedWord = customWords[type][index];
                customWords[type].splice(index, 1);
            }
            
            saveCustomData(); 
            updateGrids(); // Re-render all grids

            // Filter out the removed word from the sentence if it was present
            sentenceElements = sentenceElements.filter(el => !(el.type === type && el.value === removedWord));
            updateSentence();
        }

        // --- Core Sentence Rendering Logic ---
        function updateSentence() {
            const builder = document.getElementById('sentenceBuilder');
            const info = document.getElementById('conjugationInfo');
            const details = document.getElementById('conjugationDetails');
            
            builder.innerHTML = ''; 
            info.style.display = 'none'; 

            if (sentenceElements.length === 0) {
                builder.innerHTML = '<span class="placeholder">Arrastra y suelta palabras aqu√≠ para construir tu oraci√≥n...</span>';
                return;
            }

            let lastPronoun = null; // Changed from lastSubject to lastPronoun for clarity
            
            sentenceElements.forEach((element, index) => {
                const span = document.createElement('span');
                span.classList.add('sentence-part');
                
                let displayValue = element.value;
                let className = '';

                switch (element.type) {
                    case 'pronoun':
                        className = 'pronoun-part';
                        lastPronoun = element.value; 
                        break;
                    case 'verb':
                        className = 'verb-part';
                        if (lastPronoun) {
                            // Find verb entry from either allVerbsData or customWords.verbs
                            const verbEntry = allVerbsData[element.value] || customWords.verbs.find(v => v.verb === element.value);
                            
                            if (verbEntry && verbEntry.conjugations && verbEntry.conjugations[lastPronoun]) {
                                displayValue = verbEntry.conjugations[lastPronoun];
                                info.style.display = 'block';
                                const verbTypeDisplay = (verbEntry.type === 'irregular' || verbEntry.type === 'placeholder') ? 'Irregular' : `Regular -${element.value.slice(-2)}`;
                                details.innerHTML = `
                                    <strong>${element.value}</strong> (Tipo: ${verbTypeDisplay}) conjugado con <strong>${lastPronoun}</strong> = <strong>${displayValue}</strong>
                                    <br><small>Tiempo: Presente de indicativo</small>
                                `;
                            } else {
                                displayValue = `${element.value} (no conjugado)`; 
                                info.style.display = 'none'; // Hide info if cannot conjugate
                            }
                        } else {
                            displayValue = `${element.value} (infinitivo)`; 
                            info.style.display = 'none'; // Hide info if no subject
                        }
                        break;
                    case 'noun': 
                        className = 'noun-part';
                        break;
                    case 'article':
                        className = 'article-part';
                        break;
                    case 'adjective':
                        className = 'adjective-part';
                        break;
                    case 'adverb':
                        className = 'adverb-part';
                        break;
                    case 'preposition':
                        className = 'preposition-part';
                        break;
                    case 'conjunction':
                        className = 'conjunction-part';
                        break;
                }

                span.classList.add(className);
                span.textContent = displayValue;

                const removeBtn = document.createElement('span');
                removeBtn.classList.add('remove-sentence-part');
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (event) => {
                    event.stopPropagation(); 
                    removeWordFromSentence(index);
                };
                span.appendChild(removeBtn);

                builder.appendChild(span);
            });
        }

        function clearSentence() {
            sentenceElements = []; 
            updateSentence();
            document.getElementById('conjugationInfo').style.display = 'none'; 
        }

        // --- Collapsible Sections Logic ---
        function setupCollapsibles() {
            const headers = document.querySelectorAll('.collapsible-header');

            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.icon');
                    
                    // Close all other open sections within the same parent
                    const parent = this.closest('.left-panel');
                    if (parent) {
                        parent.querySelectorAll('.collapsible-header').forEach(otherHeader => {
                            if (otherHeader !== this && otherHeader.classList.contains('active')) {
                                otherHeader.classList.remove('active');
                                otherHeader.nextElementSibling.classList.remove('active');
                                otherHeader.querySelector('.icon').style.transform = 'rotate(0deg)'; 
                            }
                        });
                    }

                    // Toggle current section
                    this.classList.toggle('active');
                    content.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        icon.style.transform = 'rotate(90deg)';
                    } else {
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
            });
        }


        // Initialize the grids and fetch data on load
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomData(); 
            fetchVerbsData(); // Fetches verbs and then calls updateGrids
            
            // setupCollapsibles should be called after all initial HTML is in place
            setupCollapsibles(); 

            // Initialize Sortable.js
            new Sortable(document.getElementById('sentenceBuilder'), {
                animation: 150,
                ghostClass: 'sortable-ghost', 
                onEnd: function (evt) {
                    const [removed] = sentenceElements.splice(evt.oldIndex, 1);
                    sentenceElements.splice(evt.newIndex, 0, removed);
                    updateSentence(); 
                }
            });

            // Open the first collapsible section by default
            const firstHeader = document.querySelector('.collapsible-header');
            if (firstHeader) {
                firstHeader.click();
            }
        });
    </script>
</body>
</html>
