<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Sentence Builder</title>
    <style>
        /* Your existing CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .word-button {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .word-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .subject {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .verb {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .object {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        /* New styles for prepositions and connectors */
        .preposition {
            background: linear-gradient(135deg, #81e6d9 0%, #319795 100%);
            color: white;
        }

        .connector {
            background: linear-gradient(135deg, #fbd38d 0%, #dd6b20 100%);
            color: white;
        }

        .sentence-builder {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sentence-part {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .selected-subject {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .selected-verb {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .selected-object {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        /* New styles for selected prepositions and connectors */
        .selected-preposition {
            background: linear-gradient(135deg, #81e6d9 0%, #319795 100%);
            color: white;
        }

        .selected-connector {
            background: linear-gradient(135deg, #fbd38d 0%, #dd6b20 100%);
            color: white;
        }


        .clear-button {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .placeholder {
            color: #a0aec0;
            font-style: italic;
        }

        .conjugation-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            color: #4a5568;
        }

        /* Existing add vocab/noun sections */
        .add-vocab-section {
            background: #f0fff4;
            border: 2px solid #68d391;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        .add-noun-section {
            background: #ebf8ff;
            border: 2px solid #63b3ed;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        /* New add preposition/connector sections */
        .add-preposition-section {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        .add-connector-section {
            background: #fffaf0;
            border: 2px solid #ed8936;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }


        .add-vocab-title, .add-noun-title, .add-preposition-title, .add-connector-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        .add-vocab-title { color: #2f855a; }
        .add-noun-title { color: #2b6cb0; }
        .add-preposition-title { color: #2c7a7b; }
        .add-connector-title { color: #dd6b20; }


        .vocab-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        .noun-form, .preposition-form, .connector-form { /* Combine similar forms */
            display: grid;
            grid-template-columns: 1fr auto; 
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #68d391; /* Default for verb input */
        }
        .form-input.noun-input:focus {
            border-color: #63b3ed;
        }
        .form-input.preposition-input:focus {
            border-color: #38b2ac;
        }
        .form-input.connector-input:focus {
            border-color: #ed8936;
        }

        .form-select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .add-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); /* Green for verbs */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            height: fit-content;
            transition: transform 0.3s ease;
        }
        .add-button.noun-button {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); /* Blue for nouns */
        }
        .add-button.preposition-button {
            background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); /* Teal for prepositions */
        }
        .add-button.connector-button {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); /* Orange for connectors */
        }

        .add-button:hover {
            transform: translateY(-2px);
        }

        .custom-verbs, .custom-nouns, .custom-prepositions, .custom-connectors {
            margin-top: 20px;
        }

        .custom-verb-tag, .custom-noun-tag, .custom-preposition-tag, .custom-connector-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin: 4px;
            position: relative;
            color: white; /* All tags have white text */
        }
        .custom-verb-tag { background: #68d391; }
        .custom-noun-tag { background: #63b3ed; }
        .custom-preposition-tag { background: #38b2ac; }
        .custom-connector-tag { background: #ed8936; }


        .remove-verb, .remove-noun, .remove-preposition, .remove-connector {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Toggle buttons for sections */
        .toggle-vocab, .toggle-noun, .toggle-preposition, .toggle-connector {
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }
        .toggle-vocab { background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); }
        .toggle-noun { background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%); }
        .toggle-preposition { background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); }
        .toggle-connector { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }


        .toggle-vocab:hover, .toggle-noun:hover, .toggle-preposition:hover, .toggle-connector:hover {
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåü Constructor de Oraciones en Espa√±ol</h1>
        
        <div class="section">
            <div class="section-title">üìç Sujeto (Subject)</div>
            <div class="word-grid">
                <button class="word-button subject" onclick="selectSubject('yo')">yo</button>
                <button class="word-button subject" onclick="selectSubject('t√∫')">t√∫</button>
                <button class="word-button subject" onclick="selectSubject('√©l')">√©l</button>
                <button class="word-button subject" onclick="selectSubject('ella')">ella</button>
                <button class="word-button subject" onclick="selectSubject('nosotros')">nosotros</button>
                <button class="word-button subject" onclick="selectSubject('ustedes')">ustedes</button>
                <button class="word-button subject" onclick="selectSubject('ellos')">ellos</button>
                <button class="word-button subject" onclick="selectSubject('ellas')">ellas</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title">‚ö° Verbo (Verb)</div>
            <div class="word-grid" id="verbGrid">
                </div>
        </div>

        <div class="section">
            <div class="section-title">üéØ Objeto (Object)</div>
            <div class="word-grid" id="objectGrid">
                </div>
        </div>

        <div class="section">
            <div class="section-title">üîó Preposiciones (Prepositions)</div>
            <div class="word-grid" id="prepositionGrid">
                </div>
        </div>

        <div class="section">
            <div class="section-title">‚ûï Conectores (Connectors)</div>
            <div class="word-grid" id="connectorGrid">
                </div>
        </div>

        <div class="sentence-builder" id="sentenceBuilder">
            <span class="placeholder">Selecciona las palabras para construir tu oraci√≥n...</span>
        </div>

        <button class="clear-button" onclick="clearSentence()">üîÑ Limpiar Oraci√≥n</button>

        <button class="toggle-vocab" onclick="toggleVocabSection()">‚ûï A√±adir Verbos</button>

        <div class="add-vocab-section hidden" id="vocabSection">
            <div class="add-vocab-title">üå± A√±ade tus propios verbos</div>
            
            <div class="vocab-form">
                <div class="form-group">
                    <label class="form-label">Verbo (infinitivo)</label>
                    <input type="text" class="form-input" id="newVerb" placeholder="ej: caminar, correr, salir...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de verbo</label>
                    <select class="form-select" id="verbType">
                        <option value="regular-ar">Regular -AR (como hablar)</option>
                        <option value="regular-er">Regular -ER (como comer)</option>
                        <option value="regular-ir">Regular -IR (como vivir)</option>
                        <option value="irregular">Irregular (necesita conjugaciones especiales)</option>
                    </select>
                </div>
                
                <button class="add-button" onclick="addNewVerb()">‚ûï A√±adir</button>
            </div>

            <div class="custom-verbs" id="customVerbs">
                <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Verbos a√±adidos:</div>
            </div>
        </div>

        <button class="toggle-noun" onclick="toggleNounSection()">‚ûï A√±adir Sustantivos</button>

        <div class="add-noun-section hidden" id="nounSection">
            <div class="add-noun-title">üìö A√±ade tus propios sustantivos</div>
            
            <div class="noun-form">
                <div class="form-group">
                    <label class="form-label">Sustantivo</label>
                    <input type="text" class="form-input noun-input" id="newNoun" placeholder="ej: la casa, el perro, las flores...">
                </div>
                
                <button class="add-button noun-button" onclick="addNewNoun()">‚ûï A√±adir</button>
            </div>

            <div class="custom-nouns" id="customNouns">
                <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Sustantivos a√±adidos:</div>
            </div>
        </div>

        <button class="toggle-preposition" onclick="togglePrepositionSection()">‚ûï A√±adir Preposiciones</button>
        <div class="add-preposition-section hidden" id="prepositionSection">
            <div class="add-preposition-title">üìç A√±ade tus propias preposiciones</div>
            <div class="preposition-form">
                <div class="form-group">
                    <label class="form-label">Preposici√≥n</label>
                    <input type="text" class="form-input preposition-input" id="newPreposition" placeholder="ej: a, con, de, en...">
                </div>
                <button class="add-button preposition-button" onclick="addNewPreposition()">‚ûï A√±adir</button>
            </div>
            <div class="custom-prepositions" id="customPrepositions">
                <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Preposiciones a√±adidas:</div>
            </div>
        </div>

        <button class="toggle-connector" onclick="toggleConnectorSection()">‚ûï A√±adir Conectores</button>
        <div class="add-connector-section hidden" id="connectorSection">
            <div class="add-connector-title">‚ûï A√±ade tus propios conectores</div>
            <div class="connector-form">
                <div class="form-group">
                    <label class="form-label">Conector</label>
                    <input type="text" class="form-input connector-input" id="newConnector" placeholder="ej: y, o, pero, aunque...">
                </div>
                <button class="add-button connector-button" onclick="addNewConnector()">‚ûï A√±adir</button>
            </div>
            <div class="custom-connectors" id="customConnectors">
                <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Conectores a√±adidos:</div>
            </div>
        </div>


        <div class="conjugation-info" id="conjugationInfo" style="display: none;">
            <strong>üí° Informaci√≥n de conjugaci√≥n:</strong>
            <div id="conjugationDetails"></div>
        </div>
    </div>

    <script>
        let selectedSubject = null;
        let selectedVerb = null;
        let selectedObject = null;
        let selectedPreposition = null; // NEW
        let selectedConnector = null;   // NEW

        let allVerbsData = {}; 
        let customVerbs = []; 
        let customNouns = []; 
        let customPrepositions = []; // NEW
        let customConnectors = [];   // NEW

        const defaultObjects = ['el libro', 'la comida', 'el espa√±ol', 'la m√∫sica', 'el agua', 'la carta', 'el trabajo', 'la pel√≠cula'];
        const defaultPrepositions = ['a', 'ante', 'bajo', 'con', 'de', 'desde', 'en', 'entre', 'hacia', 'hasta', 'para', 'por', 'seg√∫n', 'sin', 'sobre', 'tras']; // NEW
        const defaultConnectors = ['y', 'o', 'pero', 'aunque', 'porque', 'si', 'cuando', 'mientras', 'entonces']; // NEW

        // !! IMPORTANT !!
        // Replace this with the RAW URL of your verbs.json file on GitHub
        const VERBS_JSON_URL = 'https://raw.githubusercontent.com/irwingbrian/languagelearningtool/refs/heads/main/verbs.json';

        // --- localStorage Helper Functions ---
        function saveCustomData() {
            try {
                localStorage.setItem('customVerbs', JSON.stringify(customVerbs));
                localStorage.setItem('customNouns', JSON.stringify(customNouns));
                localStorage.setItem('customPrepositions', JSON.stringify(customPrepositions)); // NEW
                localStorage.setItem('customConnectors', JSON.stringify(customConnectors));     // NEW
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                alert("Error al guardar tus palabras personalizadas. El almacenamiento local podr√≠a estar lleno o deshabilitado.");
            }
        }

        function loadCustomData() {
            try {
                const storedVerbs = localStorage.getItem('customVerbs');
                const storedNouns = localStorage.getItem('customNouns');
                const storedPrepositions = localStorage.getItem('customPrepositions'); // NEW
                const storedConnectors = localStorage.getItem('customConnectors');     // NEW
                
                if (storedVerbs) customVerbs = JSON.parse(storedVerbs);
                if (storedNouns) customNouns = JSON.parse(storedNouns);
                if (storedPrepositions) customPrepositions = JSON.parse(storedPrepositions); // NEW
                if (storedConnectors) customConnectors = JSON.parse(storedConnectors);     // NEW

            } catch (e) {
                console.error("Error loading from localStorage:", e);
                alert("Error al cargar tus palabras personalizadas. Podr√≠an estar corruptas.");
                // Clear potentially bad data
                localStorage.removeItem('customVerbs');
                localStorage.removeItem('customNouns');
                localStorage.removeItem('customPrepositions'); // NEW
                localStorage.removeItem('customConnectors');     // NEW
                customVerbs = [];
                customNouns = [];
                customPrepositions = []; // NEW
                customConnectors = [];   // NEW
            }
        }

        // Function to fetch verbs data
        async function fetchVerbsData() {
            try {
                const response = await fetch(VERBS_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allVerbsData = data; 
                updateVerbGrid(); 
            } catch (error) {
                console.error("Could not fetch verbs data:", error);
                alert("Error al cargar los verbos predeterminados. Verifica la URL del JSON o tu conexi√≥n a internet.");
            }
        }

        // Conjugation engine for regular verbs
        function conjugateRegularVerb(verb, type, subject) {
            const stem = verb.slice(0, -2); 
            
            const endings = {
                'regular-ar': {
                    'yo': 'o', 't√∫': 'as', '√©l': 'a', 'ella': 'a', 'usted': 'a', 
                    'nosotros': 'amos', 'ustedes': 'an', 'ellos': 'an', 'ellas': 'an' 
                },
                'regular-er': {
                    'yo': 'o', 't√∫': 'es', '√©l': 'e', 'ella': 'e', 'usted': 'e',
                    'nosotros': 'emos', 'ustedes': 'en', 'ellos': 'en', 'ellas': 'en' 
                },
                'regular-ir': {
                    'yo': 'o', 't√∫': 'es', '√©l': 'e', 'ella': 'e', 'usted': 'e',
                    'nosotros': 'imos', 'ustedes': 'en', 'ellos': 'en', 'ellas': 'en' 
                }
            };
            return stem + endings[type][subject];
        }

        function generateConjugation(verb, type) {
            const conjugation = {};
            const subjects = ['yo', 't√∫', '√©l', 'ella', 'usted', 'nosotros', 'ustedes', 'ellos', 'ellas']; 
            
            subjects.forEach(subject => {
                conjugation[subject] = conjugateRegularVerb(verb, type, subject);
            });

            return conjugation;
        }

        // --- Selection Functions ---
        function selectSubject(subject) {
            selectedSubject = subject;
            updateSentence();
        }

        function selectVerb(verb) {
            selectedVerb = verb;
            updateSentence();
        }

        function selectObject(object) {
            selectedObject = object;
            updateSentence();
        }

        function selectPreposition(preposition) { // NEW
            selectedPreposition = preposition;
            updateSentence();
        }

        function selectConnector(connector) { // NEW
            selectedConnector = connector;
            updateSentence();
        }

        // --- Grid Update Functions ---
        function updateVerbGrid() {
            const verbGrid = document.getElementById('verbGrid');
            verbGrid.innerHTML = ''; 

            const allVerbsToDisplay = { ...allVerbsData }; 
            customVerbs.forEach(verbData => {
                if (verbData.type !== 'irregular' && !verbData.conjugations) {
                    verbData.conjugations = generateConjugation(verbData.verb, verbData.type);
                }
                allVerbsToDisplay[verbData.verb] = verbData; 
            });

            const verbInfinitives = Object.keys(allVerbsToDisplay).sort();

            verbInfinitives.forEach(verb => {
                const button = document.createElement('button');
                button.className = 'word-button verb';
                button.textContent = verb;
                button.onclick = () => selectVerb(verb);
                
                if (customVerbs.some(v => v.verb === verb)) {
                    button.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                } else if (allVerbsToDisplay[verb].type === 'irregular') {
                    button.style.background = 'linear-gradient(135deg, #e07a5f 0%, #a43a3d 100%)'; 
                }
                
                verbGrid.appendChild(button);
            });
        }

        function updateObjectGrid() {
            const objectGrid = document.getElementById('objectGrid');
            objectGrid.innerHTML = ''; 
            
            const allNounsToDisplay = [...defaultObjects, ...customNouns].sort();

            allNounsToDisplay.forEach(object => {
                const button = document.createElement('button');
                button.className = 'word-button object';
                button.textContent = object;
                button.onclick = () => selectObject(object);
                if (customNouns.includes(object)) {
                    button.style.background = 'linear-gradient(135deg, #4299e1 0%, #3182ce 100%)';
                }
                objectGrid.appendChild(button);
            });
        }

        function updatePrepositionGrid() { // NEW
            const prepositionGrid = document.getElementById('prepositionGrid');
            prepositionGrid.innerHTML = ''; 
            
            const allPrepositionsToDisplay = [...defaultPrepositions, ...customPrepositions].sort();

            allPrepositionsToDisplay.forEach(preposition => {
                const button = document.createElement('button');
                button.className = 'word-button preposition';
                button.textContent = preposition;
                button.onclick = () => selectPreposition(preposition);
                if (customPrepositions.includes(preposition)) {
                    button.style.background = 'linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%)';
                }
                prepositionGrid.appendChild(button);
            });
        }

        function updateConnectorGrid() { // NEW
            const connectorGrid = document.getElementById('connectorGrid');
            connectorGrid.innerHTML = ''; 
            
            const allConnectorsToDisplay = [...defaultConnectors, ...customConnectors].sort();

            allConnectorsToDisplay.forEach(connector => {
                const button = document.createElement('button');
                button.className = 'word-button connector';
                button.textContent = connector;
                button.onclick = () => selectConnector(connector);
                if (customConnectors.includes(connector)) {
                    button.style.background = 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)';
                }
                connectorGrid.appendChild(button);
            });
        }

        // --- Section Toggle Functions ---
        function toggleVocabSection() {
            document.getElementById('vocabSection').classList.toggle('hidden');
        }

        function toggleNounSection() {
            document.getElementById('nounSection').classList.toggle('hidden');
        }
        
        function togglePrepositionSection() { // NEW
            document.getElementById('prepositionSection').classList.toggle('hidden');
        }

        function toggleConnectorSection() { // NEW
            document.getElementById('connectorSection').classList.toggle('hidden');
        }

        // --- Add/Remove Vocabulary Functions ---
        function addNewVerb() {
            const verbInput = document.getElementById('newVerb');
            const typeSelect = document.getElementById('verbType');
            
            const verb = verbInput.value.trim().toLowerCase();
            const type = typeSelect.value;
            
            if (!verb) {
                alert('Por favor, introduce un verbo');
                return;
            }
            
            if (allVerbsData[verb] || customVerbs.some(v => v.verb === verb)) {
                alert('Este verbo ya existe');
                return;
            }
            
            const validEndings = {
                'regular-ar': 'ar', 'regular-er': 'er', 'regular-ir': 'ir'
            };
            
            if (type !== 'irregular' && !verb.endsWith(validEndings[type])) {
                alert(`Los verbos ${type} deben terminar en -${validEndings[type]}`);
                return;
            }

            let verbData = { verb, type };

            if (type === 'irregular') {
                const confirmation = confirm(`Has seleccionado "Irregular" para "${verb}". Necesitas a√±adir sus conjugaciones manualmente. ¬øDeseas a√±adirlo como un verbo irregular gen√©rico por ahora? (Usar√° infinitivo con asterisco)`);
                if (confirmation) {
                    verbData.conjugations = {
                        'yo': `${verb}*`, 't√∫': `${verb}*`, '√©l': `${verb}*`, 'ella': `${verb}*`, 'usted': `${verb}*`,
                        'nosotros': `${verb}*`, 'ustedes': `${verb}*`, 'ellos': `${verb}*`, 'ellas': `${verb}*` 
                    };
                } else {
                    return; 
                }
            } else {
                verbData.conjugations = generateConjugation(verb, type);
            }
            
            customVerbs.push(verbData);
            saveCustomData(); 
            
            updateVerbGrid();
            updateCustomVerbsDisplay();
            
            verbInput.value = '';
            typeSelect.value = 'regular-ar';
            
            alert(`¬°Verbo "${verb}" a√±adido correctamente!`);
        }

        function addNewNoun() {
            const nounInput = document.getElementById('newNoun');
            const noun = nounInput.value.trim().toLowerCase();
            
            if (!noun) {
                alert('Por favor, introduce un sustantivo');
                return;
            }
            
            if (defaultObjects.includes(noun) || customNouns.includes(noun)) {
                alert('Este sustantivo ya existe');
                return;
            }
            
            customNouns.push(noun);
            saveCustomData(); 
            
            updateObjectGrid();
            updateCustomNounsDisplay();
            
            nounInput.value = '';
            
            alert(`¬°Sustantivo "${noun}" a√±adido correctamente!`);
        }
        
        function addNewPreposition() { // NEW
            const prepositionInput = document.getElementById('newPreposition');
            const preposition = prepositionInput.value.trim().toLowerCase();

            if (!preposition) {
                alert('Por favor, introduce una preposici√≥n.');
                return;
            }
            if (defaultPrepositions.includes(preposition) || customPrepositions.includes(preposition)) {
                alert('Esta preposici√≥n ya existe.');
                return;
            }
            
            customPrepositions.push(preposition);
            saveCustomData();
            updatePrepositionGrid();
            updateCustomPrepositionsDisplay();
            prepositionInput.value = '';
            alert(`¬°Preposici√≥n "${preposition}" a√±adida correctamente!`);
        }

        function addNewConnector() { // NEW
            const connectorInput = document.getElementById('newConnector');
            const connector = connectorInput.value.trim().toLowerCase();

            if (!connector) {
                alert('Por favor, introduce un conector.');
                return;
            }
            if (defaultConnectors.includes(connector) || customConnectors.includes(connector)) {
                alert('Este conector ya existe.');
                return;
            }
            
            customConnectors.push(connector);
            saveCustomData();
            updateConnectorGrid();
            updateCustomConnectorsDisplay();
            connectorInput.value = '';
            alert(`¬°Conector "${connector}" a√±adido correctamente!`);
        }

        function updateCustomVerbsDisplay() {
            const container = document.getElementById('customVerbs');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            
            customVerbs.forEach((verbData, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-verb-tag';
                tag.innerHTML = `${verbData.verb} (${verbData.type}) <span class="remove-verb" onclick="removeCustomVerb(${index})">√ó</span>`;
                container.appendChild(tag);
            });
        }

        function updateCustomNounsDisplay() {
            const container = document.getElementById('customNouns');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            
            customNouns.forEach((noun, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-noun-tag';
                tag.innerHTML = `${noun} <span class="remove-noun" onclick="removeCustomNoun(${index})">√ó</span>`;
                container.appendChild(tag);
            });
        }

        function updateCustomPrepositionsDisplay() { // NEW
            const container = document.getElementById('customPrepositions');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            customPrepositions.forEach((preposition, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-preposition-tag';
                tag.innerHTML = `${preposition} <span class="remove-preposition" onclick="removeCustomPreposition(${index})">√ó</span>`;
                container.appendChild(tag);
            });
        }

        function updateCustomConnectorsDisplay() { // NEW
            const container = document.getElementById('customConnectors');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            customConnectors.forEach((connector, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-connector-tag';
                tag.innerHTML = `${connector} <span class="remove-connector" onclick="removeCustomConnector(${index})">√ó</span>`;
                container.appendChild(tag);
            });
        }

        function removeCustomVerb(index) {
            const verbData = customVerbs[index];
            customVerbs.splice(index, 1);
            saveCustomData(); 
            updateVerbGrid();
            updateCustomVerbsDisplay();
            if (selectedVerb === verbData.verb) {
                selectedVerb = null;
                updateSentence();
            }
        }

        function removeCustomNoun(index) {
            const noun = customNouns[index];
            customNouns.splice(index, 1);
            saveCustomData(); 
            updateObjectGrid();
            updateCustomNounsDisplay();
            if (selectedObject === noun) {
                selectedObject = null;
                updateSentence();
            }
        }

        function removeCustomPreposition(index) { // NEW
            const preposition = customPrepositions[index];
            customPrepositions.splice(index, 1);
            saveCustomData();
            updatePrepositionGrid();
            updateCustomPrepositionsDisplay();
            if (selectedPreposition === preposition) {
                selectedPreposition = null;
                updateSentence();
            }
        }

        function removeCustomConnector(index) { // NEW
            const connector = customConnectors[index];
            customConnectors.splice(index, 1);
            saveCustomData();
            updateConnectorGrid();
            updateCustomConnectorsDisplay();
            if (selectedConnector === connector) {
                selectedConnector = null;
                updateSentence();
            }
        }

        function updateSentence() {
            const builder = document.getElementById('sentenceBuilder');
            const info = document.getElementById('conjugationInfo');
            const details = document.getElementById('conjugationDetails');
            
            if (!selectedSubject && !selectedVerb && !selectedObject && !selectedPreposition && !selectedConnector) { // Updated condition
                builder.innerHTML = '<span class="placeholder">Selecciona las palabras para construir tu oraci√≥n...</span>';
                info.style.display = 'none';
                return;
            }

            let sentenceHTML = '';
            
            // Subject
            if (selectedSubject) {
                sentenceHTML += `<span class="sentence-part selected-subject">${selectedSubject}</span>`;
            }
            
            // Verb (conjugated)
            if (selectedVerb && selectedSubject) {
                const verbEntry = customVerbs.find(v => v.verb === selectedVerb) || allVerbsData[selectedVerb];

                if (verbEntry && verbEntry.conjugations && verbEntry.conjugations[selectedSubject]) {
                    const conjugatedVerb = verbEntry.conjugations[selectedSubject];
                    sentenceHTML += `<span class="sentence-part selected-verb">${conjugatedVerb}</span>`;
                    
                    info.style.display = 'block';
                    const verbType = verbEntry.type === 'irregular' ? 'irregular' : `regular -${selectedVerb.slice(-2)}`;
                    
                    details.innerHTML = `
                        <strong>${selectedVerb}</strong> (${verbType}) conjugado con <strong>${selectedSubject}</strong> = <strong>${conjugatedVerb}</strong>
                        <br><small>Presente de indicativo</small>
                    `;
                } else {
                    sentenceHTML += `<span class="sentence-part selected-verb">${selectedVerb} (conjugaci√≥n no disponible)</span>`;
                    info.style.display = 'none';
                }
            } else if (selectedVerb) {
                sentenceHTML += `<span class="sentence-part selected-verb">${selectedVerb} (infinitivo)</span>`;
                info.style.display = 'none';
            } else {
                info.style.display = 'none';
            }
            
            // Preposition (NEW: inserted between verb and object, if both are present)
            if (selectedPreposition && selectedVerb && selectedObject) { // Preposition makes most sense with both a verb and an object
                 sentenceHTML += `<span class="sentence-part selected-preposition">${selectedPreposition}</span>`;
            } else if (selectedPreposition && (!selectedVerb || !selectedObject)) {
                // If only preposition is selected, or verb but no object, display it loosely
                sentenceHTML += `<span class="sentence-part selected-preposition">${selectedPreposition}</span>`;
            }


            // Object
            if (selectedObject) {
                sentenceHTML += `<span class="sentence-part selected-object">${selectedObject}</span>`;
            }

            // Connector (NEW: inserted after the object, or after verb if no object)
            if (selectedConnector && (selectedObject || selectedVerb)) { // Connector makes most sense with a preceding word
                sentenceHTML += `<span class="sentence-part selected-connector">${selectedConnector}</span>`;
            } else if (selectedConnector) { // If only connector is selected
                sentenceHTML += `<span class="sentence-part selected-connector">${selectedConnector}</span>`;
            }


            if (sentenceHTML) {
                builder.innerHTML = sentenceHTML;
            } else {
                builder.innerHTML = '<span class="placeholder">Selecciona las palabras para construir tu oraci√≥n...</span>';
            }
        }

        function clearSentence() {
            selectedSubject = null;
            selectedVerb = null;
            selectedObject = null;
            selectedPreposition = null; // NEW
            selectedConnector = null;   // NEW
            updateSentence();
        }

        // Initialize the grids and fetch data on load
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomData(); // Load custom data FIRST
            fetchVerbsData(); // Then fetch default verbs (they merge into the display)
            updateObjectGrid(); 
            updatePrepositionGrid(); // NEW
            updateConnectorGrid();   // NEW
            updateCustomVerbsDisplay(); 
            updateCustomNounsDisplay();
            updateCustomPrepositionsDisplay(); // NEW
            updateCustomConnectorsDisplay();   // NEW
        });
    </script>
</body>
</html>
