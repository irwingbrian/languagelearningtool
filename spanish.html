<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Sentence Builder</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <style>
        /* Your existing CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex; /* Use flexbox for overall centering if needed */
            justify-content: center; /* Center horizontally */
            align-items: flex-start; /* Align to the top of the viewport */
        }

        /* New container for the two-panel layout */
        .main-container {
            max-width: 1200px; /* Increased max-width for two panels */
            width: 100%;
            margin: 0 auto; /* Center the container */
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; /* Stacks the H1 above the panels */
            gap: 20px; /* Space between title and panels */
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px; /* Reduced margin, as main-container has gap now */
            font-size: 2.5em;
            font-weight: 300;
        }

        /* Flex container for the two panels */
        .main-layout {
            display: flex;
            gap: 30px; /* Space between the left and right panels */
            flex-wrap: wrap; /* Allows panels to stack on smaller screens */
            width: 100%;
        }

        .left-panel, .right-panel {
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            /* flex: 1; default for even distribution */
        }

        .left-panel {
            flex: 2; /* Left panel takes more space (e.g., 2/3 of available space) */
            background: #e9f0f9; /* Light background for building blocks */
            min-width: 300px; /* Ensure left panel doesn't get too small */
            max-height: 85vh; /* Limit height to enable scrolling within the panel */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 15px; /* Adjust padding for scrollbar */
        }

        /* Custom scrollbar for left panel */
        .left-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .left-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .left-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .right-panel {
            flex: 1; /* Right panel takes less space (e.g., 1/3 of available space) */
            background: #f7fafc; /* Lighter background for sentence */
            border: 2px dashed #cbd5e0; /* Match sentence builder border visually */
            min-width: 280px; /* Ensure right panel doesn't get too small */
            display: flex;
            flex-direction: column; /* Stack sentence, button, info vertically */
            justify-content: flex-start; /* Align content to the top */
            position: sticky; /* Keep it visible when scrolling left panel */
            top: 20px; /* Distance from top of viewport */
            align-self: flex-start; /* Align to the start of the cross axis (top) */
            min-height: 250px; /* Ensure some minimum height */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 900px) {
            .main-layout {
                flex-direction: column; /* Stack panels vertically */
            }
            .left-panel, .right-panel {
                min-width: unset; /* Remove min-width when stacked */
                max-height: unset; /* Remove max-height, allow content to dictate height */
                overflow-y: visible; /* No internal scrolling when stacked */
                position: static; /* Remove sticky positioning */
            }
        }

        /* Styles for collapsible sections */
        .collapsible-section {
            margin-bottom: 15px; /* Space between collapsible blocks */
            border-radius: 10px;
            overflow: hidden; /* Important for max-height transition */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .collapsible-header {
            background: #e2e8f0;
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #cbd5e0;
            transition: background-color 0.2s ease;
        }

        .collapsible-header:hover {
            background-color: #d8dee7;
        }

        .collapsible-header .icon {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }

        .collapsible-header.active .icon {
            transform: rotate(90deg); /* Rotate for expand indication */
        }

        .collapsible-content {
            background: white;
            max-height: 0; /* Hidden by default */
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* Smooth transition */
            padding: 0 20px; /* No padding when collapsed */
        }

        .collapsible-content.active {
            max-height: 500px; /* Or a sufficiently large value for content to show */
            padding: 20px; /* Add padding when expanded */
            /* You might need to adjust max-height if your word grids become very long */
            /* A better approach for very dynamic content might be JS-calculated height */
        }

        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Adjusted minmax for more columns */
            gap: 8px; /* Slightly reduced gap */
            margin-bottom: 0; /* Remove bottom margin from grid, controlled by content padding */
        }

        .word-button {
            padding: 10px 14px; /* Slightly smaller padding for denser grid */
            border: none;
            border-radius: 10px; /* Slightly smaller radius */
            cursor: pointer;
            font-size: 13px; /* Slightly smaller font */
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* Slightly smaller shadow */
        }

        .word-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }

        .subject {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .verb {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .object { /* Renamed from .object to .noun for consistency with internal data types */
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .preposition {
            background: linear-gradient(135deg, #81e6d9 0%, #319795 100%);
            color: white;
        }

        .connector {
            background: linear-gradient(135deg, #fbd38d 0%, #dd6b20 100%);
            color: white;
        }

        .sentence-builder {
            border: none;
            background: none;
            padding: 10px;
            text-align: center;
            margin: 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            flex-grow: 1; 
        }

        .sentence-part {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 8px rgba[0m rgba(0,0,0,0.1);
            cursor: grab;
            display: flex;
            align-items: center;
            position: relative;
        }

        .remove-sentence-part {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            line-height: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s;
        }

        .remove-sentence-part:hover {
            background-color: #c53030;
        }

        .sentence-part.subject-part { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sentence-part.verb-part { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .sentence-part.noun-part { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .sentence-part.preposition-part { background: linear-gradient(135deg, #81e6d9 0%, #319795 100%); color: white; }
        .sentence-part.connector-part { background: linear-gradient(135deg, #fbd38d 0%, #dd6b20 100%); color: white; }

        .clear-button {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .placeholder {
            color: #a0aec0;
            font-style: italic;
        }

        .conjugation-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            color: #4a5568;
        }

        /* Existing add vocab/noun sections */
        .add-vocab-section {
            background: #f0fff4;
            border: 2px solid #68d391;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        .add-noun-section {
            background: #ebf8ff;
            border: 2px solid #63b3ed;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        /* New add preposition/connector sections */
        .add-preposition-section {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        .add-connector-section {
            background: #fffaf0;
            border: 2px solid #ed8936;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }


        .add-vocab-title, .add-noun-title, .add-preposition-title, .add-connector-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        .add-vocab-title { color: #2f855a; }
        .add-noun-title { color: #2b6cb0; }
        .add-preposition-title { color: #2c7a7b; }
        .add-connector-title { color: #dd6b20; }


        .vocab-form {
            display: grid;
            /* Changed from 1fr 1fr auto to just 1fr for single column input field */
            grid-template-columns: 1fr; /* Single column for input and button below */
            gap: 15px;
            align-items: end;
        }
        .noun-form, .preposition-form, .connector-form { /* Combine similar forms */
            display: grid;
            grid-template-columns: 1fr auto; 
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #68d391; /* Default for verb input */
        }
        .form-input.noun-input:focus {
            border-color: #63b3ed;
        }
        .form-input.preposition-input:focus {
            border-color: #38b2ac;
        }
        .form-input.connector-input:focus {
            border-color: #ed8936;
        }

        .form-select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .add-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); /* Green for verbs */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            height: fit-content;
            transition: transform 0.3s ease;
            width: 100%; /* Make add button full width */
        }
        .add-button.noun-button {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); /* Blue for nouns */
            width: auto; /* Reset width for other forms if needed */
        }
        .add-button.preposition-button {
            background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); /* Teal for prepositions */
            width: auto;
        }
        .add-button.connector-button {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); /* Orange for connectors */
            width: auto;
        }

        .add-button:hover {
            transform: translateY(-2px);
        }

        .custom-verbs, .custom-nouns, .custom-prepositions, .custom-connectors {
            margin-top: 20px;
        }

        .custom-verb-tag, .custom-noun-tag, .custom-preposition-tag, .custom-connector-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin: 4px;
            position: relative;
            color: white; /* All tags have white text */
        }
        .custom-verb-tag { background: #68d391; }
        .custom-noun-tag { background: #63b3ed; }
        .custom-preposition-tag { background: #38b2ac; }
        .custom-connector-tag { background: #ed8936; }


        .remove-tag { /* Combined remove styles for custom word tags */
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Toggle buttons for sections (moved to left panel, used for add-vocab sections) */
        .toggle-vocab, .toggle-noun, .toggle-preposition, .toggle-connector {
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }
        .toggle-vocab { background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); }
        .toggle-noun { background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%); }
        .toggle-preposition { background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); }
        .toggle-connector { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }


        .toggle-vocab:hover, .toggle-noun:hover, .toggle-preposition:hover, .toggle-connector:hover {
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>🌟 Constructor de Oraciones en Español</h1>
        
        <div class="main-layout">
            <div class="left-panel">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <span>📍 Sujeto (Subject)</span>
                        <span class="icon">►</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid">
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'yo')">yo</button>
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'tú')">tú</button>
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'él')">él</button>
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'ella')">ella</button>
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'nosotros')">nosotros</button>
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'ustedes')">ustedes</button>
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'ellos')">ellos</button>
                            <button class="word-button subject" onclick="addWordToSentence('subject', 'ellas')">ellas</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <span>⚡ Verbo (Verb)</span>
                        <span class="icon">►</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="verbGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <span>🎯 Sustantivo (Noun)</span>
                        <span class="icon">►</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="nounGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <span>🔗 Preposiciones (Prepositions)</span>
                        <span class="icon">►</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="prepositionGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <span>➕ Conectores (Connectors)</span>
                        <span class="icon">►</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="word-grid" id="connectorGrid">
                            </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <span>💡 Modo (Mood)</span>
                        <span class="icon">►</span>
                    </div>
                    <div class="collapsible-content">
                        <p style="text-align: center; color: #6a6a6a; font-style: italic; padding: 10px;">
                            (Funcionalidad futura: elige el modo del verbo)
                        </p>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <span>⏰ Tiempo (Tense)</span>
                        <span class="icon">►</span>
                    </div>
                    <div class="collapsible-content">
                        <p style="text-align: center; color: #6a6a6a; font-style: italic; padding: 10px;">
                            (Funcionalidad futura: elige el tiempo verbal)
                        </p>
                    </div>
                </div>

                <button class="toggle-vocab" onclick="toggleVocabSection()">➕ Añadir Verbos</button>
                <div class="add-vocab-section hidden" id="vocabSection">
                    <div class="add-vocab-title">🌱 Añade tus propios verbos</div>
                    <div class="vocab-form">
                        <div class="form-group">
                            <label class="form-label">Verbo (infinitivo)</label>
                            <input type="text" class="form-input" id="newVerb" placeholder="ej: caminar, correr, salir...">
                        </div>
                        <button class="add-button" onclick="addNewVerb()">➕ Añadir Verbo</button>
                    </div>
                    <div class="custom-verbs" id="customVerbs">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Verbos añadidos:</div>
                    </div>
                </div>

                <button class="toggle-noun" onclick="toggleNounSection()">➕ Añadir Sustantivos</button>
                <div class="add-noun-section hidden" id="nounSection">
                    <div class="add-noun-title">📚 Añade tus propios sustantivos</div>
                    <div class="noun-form">
                        <div class="form-group">
                            <label class="form-label">Sustantivo</label>
                            <input type="text" class="form-input noun-input" id="newNoun" placeholder="ej: la casa, el perro, las flores...">
                        </div>
                        <button class="add-button noun-button" onclick="addNewNoun()">➕ Añadir</button>
                    </div>
                    <div class="custom-nouns" id="customNouns">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Sustantivos añadidos:</div>
                    </div>
                </div>

                <button class="toggle-preposition" onclick="togglePrepositionSection()">➕ Añadir Preposiciones</button>
                <div class="add-preposition-section hidden" id="prepositionSection">
                    <div class="add-preposition-title">📍 Añade tus propias preposiciones</div>
                    <div class="preposition-form">
                        <div class="form-group">
                            <label class="form-label">Preposición</label>
                            <input type="text" class="form-input preposition-input" id="newPreposition" placeholder="ej: a, con, de, en...">
                        </div>
                        <button class="add-button preposition-button" onclick="addNewPreposition()">➕ Añadir</button>
                    </div>
                    <div class="custom-prepositions" id="customPrepositions">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Preposiciones añadidas:</div>
                    </div>
                </div>

                <button class="toggle-connector" onclick="toggleConnectorSection()">➕ Añadir Conectores</button>
                <div class="add-connector-section hidden" id="connectorSection">
                    <div class="add-connector-title">➕ Añade tus propios conectores</div>
                    <div class="connector-form">
                        <div class="form-group">
                            <label class="form-label">Conector</label>
                            <input type="text" class="form-input connector-input" id="newConnector" placeholder="ej: y, o, pero, aunque...">
                        </div>
                        <button class="add-button connector-button" onclick="addNewConnector()">➕ Añadir</button>
                    </div>
                    <div class="custom-connectors" id="customConnectors">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">Conectores añadidos:</div>
                    </div>
                </div>
            </div> <div class="right-panel">
                <div class="sentence-builder" id="sentenceBuilder">
                    <span class="placeholder">Arrastra y suelta palabras aquí para construir tu oración...</span>
                </div>

                <button class="clear-button" onclick="clearSentence()">🔄 Limpiar Oración</button>

                <div class="conjugation-info" id="conjugationInfo" style="display: none;">
                    <strong>💡 Información de conjugación:</strong>
                    <div id="conjugationDetails"></div>
                </div>
            </div> </div> </div> <script>
        // Use an array to store the full sentence, allowing flexible order
        let sentenceElements = []; 

        let allVerbsData = {}; 
        let customVerbs = []; 
        let customNouns = []; 
        let customPrepositions = []; 
        let customConnectors = [];   

        const defaultNouns = ['el libro', 'la comida', 'el español', 'la música', 'el agua', 'la carta', 'el trabajo', 'la película']; 
        const defaultPrepositions = ['a', 'ante', 'bajo', 'con', 'de', 'desde', 'en', 'entre', 'hacia', 'hasta', 'para', 'por', 'según', 'sin', 'sobre', 'tras']; 
        const defaultConnectors = ['y', 'o', 'pero', 'aunque', 'porque', 'si', 'cuando', 'mientras', 'entonces']; 

        const VERBS_JSON_URL = 'https://raw.githubusercontent.com/irwingbrian/languagelearningtool/refs/heads/main/verbs.json';

        // --- localStorage Helper Functions ---
        function saveCustomData() {
            try {
                localStorage.setItem('customVerbs', JSON.stringify(customVerbs));
                localStorage.setItem('customNouns', JSON.stringify(customNouns));
                localStorage.setItem('customPrepositions', JSON.stringify(customPrepositions)); 
                localStorage.setItem('customConnectors', JSON.stringify(customConnectors));     
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                alert("Error al guardar tus palabras personalizadas. El almacenamiento local podría estar lleno o deshabilitado.");
            }
        }

        function loadCustomData() {
            try {
                const storedVerbs = localStorage.getItem('customVerbs');
                const storedNouns = localStorage.getItem('customNouns');
                const storedPrepositions = localStorage.getItem('customPrepositions'); 
                const storedConnectors = localStorage.getItem('customConnectors');     
                
                if (storedVerbs) customVerbs = JSON.parse(storedVerbs);
                if (storedNouns) customNouns = JSON.parse(storedNouns);
                if (storedPrepositions) customPrepositions = JSON.parse(storedPrepositions); 
                if (storedConnectors) customConnectors = JSON.parse(storedConnectors);     

            } catch (e) {
                console.error("Error loading from localStorage:", e);
                alert("Error al cargar tus palabras personalizadas. Podrían estar corruptas.");
                localStorage.removeItem('customVerbs');
                localStorage.removeItem('customNouns');
                localStorage.removeItem('customPrepositions'); 
                localStorage.removeItem('customConnectors');     
                customVerbs = [];
                customNouns = [];
                customPrepositions = []; 
                customConnectors = [];   
            }
        }

        // Function to fetch verbs data
        async function fetchVerbsData() {
            try {
                const response = await fetch(VERBS_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allVerbsData = data; 
                updateVerbGrid(); 
            } catch (error) {
                console.error("Could not fetch verbs data:", error);
                alert("Error al cargar los verbos predeterminados. Verifica la URL del JSON o tu conexión a internet.");
            }
        }

        // Conjugation engine for regular verbs
        function conjugateRegularVerb(verb, type, subject) {
            const stem = verb.slice(0, -2); 
            
            const endings = {
                'regular-ar': {
                    'yo': 'o', 'tú': 'as', 'él': 'a', 'ella': 'a', 'usted': 'a', 
                    'nosotros': 'amos', 'ustedes': 'an', 'ellos': 'an', 'ellas': 'an' 
                },
                'regular-er': {
                    'yo': 'o', 'tú': 'es', 'él': 'e', 'ella': 'e', 'usted': 'e',
                    'nosotros': 'emos', 'ustedes': 'en', 'ellos': 'en', 'ellas': 'en' 
                },
                'regular-ir': {
                    'yo': 'o', 'tú': 'es', 'él': 'e', 'ella': 'e', 'usted': 'e',
                    'nosotros': 'imos', 'ustedes': 'en', 'ellos': 'en', 'ellas': 'en' 
                }
            };
            return stem + endings[type][subject];
        }

        function generateConjugation(verb, type) {
            const conjugation = {};
            const subjects = ['yo', 'tú', 'él', 'ella', 'usted', 'nosotros', 'ustedes', 'ellos', 'ellas']; 
            
            subjects.forEach(subject => {
                conjugation[subject] = conjugateRegularVerb(verb, type, subject);
            });

            return conjugation;
        }

        // --- Add Word to Sentence Function (replaces select functions) ---
        function addWordToSentence(type, value) {
            sentenceElements.push({ type, value });
            updateSentence();
        }

        function removeWordFromSentence(index) {
            sentenceElements.splice(index, 1);
            updateSentence();
        }

        // --- Grid Update Functions ---
        function updateVerbGrid() {
            const verbGrid = document.getElementById('verbGrid');
            verbGrid.innerHTML = ''; 

            const allVerbsToDisplay = { ...allVerbsData }; 
            customVerbs.forEach(verbData => {
                // Ensure custom verbs (especially irregular ones without conjugations from input)
                // get basic conjugation placeholders if they don't have full data.
                if (!verbData.conjugations) {
                    if (verbData.type !== 'irregular') {
                         verbData.conjugations = generateConjugation(verbData.verb, verbData.type);
                    } else {
                        // For irregular custom verbs without specific conjugations, use a placeholder
                        verbData.conjugations = {
                            'yo': `${verbData.verb}*`, 'tú': `${verbData.verb}*`, 'él': `${verbData.verb}*`, 'ella': `${verbData.verb}*`, 'usted': `${verbData.verb}*`,
                            'nosotros': `${verbData.verb}*`, 'ustedes': `${verbData.verb}*`, 'ellos': `${verbData.verb}*`, 'ellas': `${verbData.verb}*` 
                        };
                    }
                }
                allVerbsToDisplay[verbData.verb] = verbData; 
            });

            const verbInfinitives = Object.keys(allVerbsToDisplay).sort();

            verbInfinitives.forEach(verb => {
                const button = document.createElement('button');
                button.className = 'word-button verb';
                button.textContent = verb;
                button.onclick = () => addWordToSentence('verb', verb); 
                
                const verbInfo = allVerbsToDisplay[verb];

                if (customVerbs.some(v => v.verb === verb)) {
                    button.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)'; // Custom verb color
                } else if (verbInfo.type === 'irregular') {
                    button.style.background = 'linear-gradient(135deg, #e07a5f 0%, #a43a3d 100%)'; // Irregular verb color
                } else {
                    button.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'; // Default regular verb color
                }
                
                verbGrid.appendChild(button);
            });
        }

        function updateNounGrid() { 
            const nounGrid = document.getElementById('nounGrid'); 
            nounGrid.innerHTML = ''; 
            
            const allNounsToDisplay = [...defaultNouns, ...customNouns].sort(); 

            allNounsToDisplay.forEach(noun => {
                const button = document.createElement('button');
                button.className = 'word-button noun'; 
                button.textContent = noun;
                button.onclick = () => addWordToSentence('noun', noun); 
                if (customNouns.includes(noun)) {
                    button.style.background = 'linear-gradient(135deg, #4299e1 0%, #3182ce 100%)';
                }
                nounGrid.appendChild(button);
            });
        }

        function updatePrepositionGrid() { 
            const prepositionGrid = document.getElementById('prepositionGrid');
            prepositionGrid.innerHTML = ''; 
            
            const allPrepositionsToDisplay = [...defaultPrepositions, ...customPrepositions].sort();

            allPrepositionsToDisplay.forEach(preposition => {
                const button = document.createElement('button');
                button.className = 'word-button preposition';
                button.textContent = preposition;
                button.onclick = () => addWordToSentence('preposition', preposition); 
                if (customPrepositions.includes(preposition)) {
                    button.style.background = 'linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%)';
                }
                prepositionGrid.appendChild(button);
            });
        }

        function updateConnectorGrid() { 
            const connectorGrid = document.getElementById('connectorGrid');
            connectorGrid.innerHTML = ''; 
            
            const allConnectorsToDisplay = [...defaultConnectors, ...customConnectors].sort();

            allConnectorsToDisplay.forEach(connector => {
                const button = document.createElement('button');
                button.className = 'word-button connector';
                button.textContent = connector;
                button.onclick = () => addWordToSentence('connector', connector); 
                if (customConnectors.includes(connector)) {
                    button.style.background = 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)';
                }
                connectorGrid.appendChild(button);
            });
        }

        // --- Section Toggle Functions ---
        function toggleVocabSection() {
            document.getElementById('vocabSection').classList.toggle('hidden');
        }

        function toggleNounSection() {
            document.getElementById('nounSection').classList.toggle('hidden');
        }
        
        function togglePrepositionSection() { 
            document.getElementById('prepositionSection').classList.toggle('hidden');
        }

        function toggleConnectorSection() { 
            document.getElementById('connectorSection').classList.toggle('hidden');
        }

        // --- Add/Remove Vocabulary Functions ---
        function addNewVerb() {
            const verbInput = document.getElementById('newVerb');
            const verb = verbInput.value.trim().toLowerCase();
            
            if (!verb) {
                alert('Por favor, introduce un verbo.');
                return;
            }
            
            if (allVerbsData[verb] || customVerbs.some(v => v.verb === verb)) {
                alert('Este verbo ya existe en la lista predeterminada o en tus verbos personalizados.');
                return;
            }

            let verbType;
            let conjugations = {};

            // Automatic type detection for new verbs
            if (verb.endsWith('ar')) {
                verbType = 'regular-ar';
                conjugations = generateConjugation(verb, verbType);
            } else if (verb.endsWith('er')) {
                verbType = 'regular-er';
                conjugations = generateConjugation(verb, verbType);
            } else if (verb.endsWith('ir')) {
                verbType = 'regular-ir';
                conjugations = generateConjugation(verb, verbType);
            } else {
                // If ending is not -ar, -er, -ir, assume irregular
                verbType = 'irregular';
                const confirmation = confirm(`"${verb}" no termina en -ar, -er, o -ir. Se clasificará como "Irregular". Necesitarás gestionar sus conjugaciones si la herramienta avanza. ¿Deseas añadirlo de todos modos?`);
                if (!confirmation) {
                    return; 
                }
                // For irregular custom verbs without specific conjugations, use a placeholder
                conjugations = {
                    'yo': `${verb}*`, 'tú': `${verb}*`, 'él': `${verb}*`, 'ella': `${verb}*`, 'usted': `${verb}*`,
                    'nosotros': `${verb}*`, 'ustedes': `${verb}*`, 'ellos': `${verb}*`, 'ellas': `${verb}*` 
                };
            }
            
            customVerbs.push({ verb, type: verbType, conjugations });
            saveCustomData(); 
            
            updateVerbGrid();
            updateCustomVerbsDisplay();
            
            verbInput.value = '';
            
            alert(`¡Verbo "${verb}" (tipo: ${verbType}) añadido correctamente!`);
        }

        function addNewNoun() {
            const nounInput = document.getElementById('newNoun');
            const noun = nounInput.value.trim().toLowerCase();
            
            if (!noun) {
                alert('Por favor, introduce un sustantivo');
                return;
            }
            
            if (defaultNouns.includes(noun) || customNouns.includes(noun)) {
                alert('Este sustantivo ya existe');
                return;
            }
            
            customNouns.push(noun);
            saveCustomData(); 
            
            updateNounGrid(); 
            updateCustomNounsDisplay();
            
            nounInput.value = '';
            
            alert(`¡Sustantivo "${noun}" añadido correctamente!`);
        }
        
        function addNewPreposition() { 
            const prepositionInput = document.getElementById('newPreposition');
            const preposition = prepositionInput.value.trim().toLowerCase();

            if (!preposition) {
                alert('Por favor, introduce una preposición.');
                return;
            }
            if (defaultPrepositions.includes(preposition) || customPrepositions.includes(preposition)) {
                alert('Esta preposición ya existe.');
                return;
            }
            
            customPrepositions.push(preposition);
            saveCustomData();
            updatePrepositionGrid();
            updateCustomPrepositionsDisplay();
            prepositionInput.value = '';
            alert(`¡Preposición "${preposition}" añadida correctamente!`);
        }

        function addNewConnector() { 
            const connectorInput = document.getElementById('newConnector');
            const connector = connectorInput.value.trim().toLowerCase();

            if (!connector) {
                alert('Por favor, introduce un conector.');
                return;
            }
            if (defaultConnectors.includes(connector) || customConnectors.includes(connector)) {
                alert('Este conector ya existe.');
                return;
            }
            
            customConnectors.push(connector);
            saveCustomData();
            updateConnectorGrid();
            updateCustomConnectorsDisplay();
            connectorInput.value = '';
            alert(`¡Conector "${connector}" añadido correctamente!`);
        }

        function updateCustomVerbsDisplay() {
            const container = document.getElementById('customVerbs');
            while (container.children.length > 1) { // Keep the title div
                container.removeChild(container.lastChild);
            }
            
            customVerbs.forEach((verbData, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-verb-tag';
                // Display type for custom verbs
                tag.innerHTML = `${verbData.verb} (${verbData.type}) <span class="remove-tag" onclick="removeCustomVerb(${index})">×</span>`;
                container.appendChild(tag);
            });
        }

        function updateCustomNounsDisplay() {
            const container = document.getElementById('customNouns');
            while (container.children.length > 1) { // Keep the title div
                container.removeChild(container.lastChild);
            }
            
            customNouns.forEach((noun, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-noun-tag';
                tag.innerHTML = `${noun} <span class="remove-tag" onclick="removeCustomNoun(${index})">×</span>`;
                container.appendChild(tag);
            });
        }

        function updateCustomPrepositionsDisplay() { 
            const container = document.getElementById('customPrepositions');
            while (container.children.length > 1) { // Keep the title div
                container.removeChild(container.lastChild);
            }
            customPrepositions.forEach((preposition, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-preposition-tag';
                tag.innerHTML = `${preposition} <span class="remove-tag" onclick="removeCustomPreposition(${index})">×</span>`;
                container.appendChild(tag);
            });
        }

        function updateCustomConnectorsDisplay() { 
            const container = document.getElementById('customConnectors');
            while (container.children.length > 1) { // Keep the title div
                container.removeChild(container.lastChild);
            }
            customConnectors.forEach((connector, index) => {
                const tag = document.createElement('span');
                tag.className = 'custom-connector-tag';
                tag.innerHTML = `${connector} <span class="remove-tag" onclick="removeCustomConnector(${index})">×</span>`;
                container.appendChild(tag);
            });
        }

        function removeCustomVerb(index) {
            const verbData = customVerbs[index];
            customVerbs.splice(index, 1);
            saveCustomData(); 
            updateVerbGrid();
            updateCustomVerbsDisplay();
            sentenceElements = sentenceElements.filter(el => !(el.type === 'verb' && el.value === verbData.verb));
            updateSentence();
        }

        function removeCustomNoun(index) {
            const noun = customNouns[index];
            customNouns.splice(index, 1);
            saveCustomData(); 
            updateNounGrid(); 
            updateCustomNounsDisplay();
            sentenceElements = sentenceElements.filter(el => !(el.type === 'noun' && el.value === noun));
            updateSentence();
        }

        function removeCustomPreposition(index) { 
            const preposition = customPrepositions[index];
            customPrepositions.splice(index, 1);
            saveCustomData();
            updatePrepositionGrid();
            updateCustomPrepositionsDisplay();
            sentenceElements = sentenceElements.filter(el => !(el.type === 'preposition' && el.value === preposition));
            updateSentence();
        }

        function removeCustomConnector(index) { 
            const connector = customConnectors[index];
            customConnectors.splice(index, 1);
            saveCustomData();
            updateConnectorGrid();
            updateCustomConnectorsDisplay();
            sentenceElements = sentenceElements.filter(el => !(el.type === 'connector' && el.value === connector));
            updateSentence();
        }

        // --- Core Sentence Rendering Logic ---
        function updateSentence() {
            const builder = document.getElementById('sentenceBuilder');
            const info = document.getElementById('conjugationInfo');
            const details = document.getElementById('conjugationDetails');
            
            builder.innerHTML = ''; 
            info.style.display = 'none'; 

            if (sentenceElements.length === 0) {
                builder.innerHTML = '<span class="placeholder">Arrastra y suelta palabras aquí para construir tu oración...</span>';
                return;
            }

            let lastSubject = null;
            
            sentenceElements.forEach((element, index) => {
                const span = document.createElement('span');
                span.classList.add('sentence-part');
                
                let displayValue = element.value;
                let className = '';

                switch (element.type) {
                    case 'subject':
                        className = 'subject-part';
                        lastSubject = element.value; 
                        break;
                    case 'verb':
                        className = 'verb-part';
                        if (lastSubject) {
                            const verbEntry = customVerbs.find(v => v.verb === element.value) || allVerbsData[element.value];
                            if (verbEntry && verbEntry.conjugations && verbEntry.conjugations[lastSubject]) {
                                displayValue = verbEntry.conjugations[lastSubject];
                                info.style.display = 'block';
                                const verbTypeDisplay = (verbEntry.type === 'irregular' || verbEntry.type === 'placeholder') ? 'irregular' : `regular -${element.value.slice(-2)}`;
                                details.innerHTML = `
                                    <strong>${element.value}</strong> (${verbTypeDisplay}) conjugado con <strong>${lastSubject}</strong> = <strong>${displayValue}</strong>
                                    <br><small>Presente de indicativo</small>
                                `;
                            } else {
                                // Fallback for verbs without full conjugations (e.g., placeholder irregulars)
                                displayValue = `${element.value}* (conjugación no disponible)`;
                            }
                        } else {
                            displayValue = `${element.value} (infinitivo)`; 
                        }
                        break;
                    case 'noun': 
                        className = 'noun-part';
                        break;
                    case 'preposition':
                        className = 'preposition-part';
                        break;
                    case 'connector':
                        className = 'connector-part';
                        break;
                }

                span.classList.add(className);
                span.textContent = displayValue;

                const removeBtn = document.createElement('span');
                removeBtn.classList.add('remove-sentence-part');
                removeBtn.textContent = '×';
                removeBtn.onclick = (event) => {
                    event.stopPropagation(); 
                    removeWordFromSentence(index);
                };
                span.appendChild(removeBtn);

                builder.appendChild(span);
            });
        }

        function clearSentence() {
            sentenceElements = []; 
            updateSentence();
            document.getElementById('conjugationInfo').style.display = 'none'; 
        }

        // --- Collapsible Sections Logic ---
        function setupCollapsibles() {
            const headers = document.querySelectorAll('.collapsible-header');

            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.icon');
                    
                    // Close all other open sections
                    headers.forEach(otherHeader => {
                        if (otherHeader !== this && otherHeader.classList.contains('active')) {
                            otherHeader.classList.remove('active');
                            otherHeader.nextElementSibling.classList.remove('active');
                            otherHeader.querySelector('.icon').style.transform = 'rotate(0deg)'; // Reset icon
                        }
                    });

                    // Toggle current section
                    this.classList.toggle('active');
                    content.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        icon.style.transform = 'rotate(90deg)';
                    } else {
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
            });
        }


        // Initialize the grids and fetch data on load
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomData(); 
            fetchVerbsData(); 
            updateNounGrid(); 
            updatePrepositionGrid(); 
            updateConnectorGrid();   
            updateCustomVerbsDisplay(); 
            updateCustomNounsDisplay();
            updateCustomPrepositionsDisplay(); 
            updateCustomConnectorsDisplay();   

            setupCollapsibles(); // Initialize collapsible behavior

            // Initialize Sortable.js
            new Sortable(document.getElementById('sentenceBuilder'), {
                animation: 150,
                ghostClass: 'sortable-ghost', 
                onEnd: function (evt) {
                    const [removed] = sentenceElements.splice(evt.oldIndex, 1);
                    sentenceElements.splice(evt.newIndex, 0, removed);
                    updateSentence(); 
                }
            });

            // Optionally, open the first collapsible section by default
            const firstHeader = document.querySelector('.collapsible-header');
            if (firstHeader) {
                firstHeader.click();
            }
        });
    </script>
</body>
</html>
